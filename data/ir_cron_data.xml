<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data noupdate="1">
        <!-- Bekleyen İşlemleri Kontrol Et -->
        <record id="cron_check_pending_transactions" model="ir.cron">
            <field name="name">POS: Bekleyen İşlemleri Kontrol Et</field>
            <field name="model_id" search="[('model', '=', 'payment.transaction')]" model="ir.model"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Bekleyen işlemleri kontrol et
cutoff = datetime.datetime.now() - datetime.timedelta(hours=1)
pending_transactions = env['payment.transaction'].search([
    ('state', '=', 'pending'),
    ('pos_order_id', '!=', False),
    ('create_date', '<', cutoff)
])
for tx in pending_transactions:
    try:
        tx.action_query_status()
    except Exception as e:
        log("Error checking transaction %s: %s" % (tx.reference, str(e)), level='error')
            ]]></field>
            <field name="interval_number">15</field>
            <field name="interval_type">minutes</field>
            <field name="numbercall">-1</field>
            <field name="doall" eval="False"/>
            <field name="active" eval="True"/>
        </record>

        <!-- Günlük Mutabakat Raporu -->
        <record id="cron_daily_reconciliation" model="ir.cron">
            <field name="name">POS: Günlük Mutabakat Raporu</field>
            <field name="model_id" search="[('model', '=', 'pos.reconciliation')]" model="ir.model"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Günlük mutabakat raporu oluştur
yesterday = datetime.datetime.now() - datetime.timedelta(days=1)
providers = env['payment.provider'].search([
    ('code', 'in', ['akbank', 'garanti', 'isbank', 'ziraat', 'halkbank', 
                    'vakifbank', 'vakifkatilim', 'yapikredi', 'finansbank',
                    'denizbank', 'teb', 'sekerbank', 'kuveytturk', 'param', 'tosla']),
    ('state', '=', 'enabled')
])

for provider in providers:
    reconciliation = env['pos.reconciliation'].create({
        'name': "MUT/%s/%s" % (yesterday.strftime('%Y%m%d'), provider.code.upper()),
        'date_start': yesterday.date(),
        'date_end': yesterday.date(),
        'provider_id': provider.id,
    })
    reconciliation.action_load_transactions()
            ]]></field>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field>
            <field name="doall" eval="False"/>
            <field name="active" eval="True"/>
        </record>

        <!-- Eski İşlemleri Arşivle -->
        <record id="cron_archive_old_transactions" model="ir.cron">
            <field name="name">POS: Eski İşlemleri Arşivle</field>
            <field name="model_id" search="[('model', '=', 'payment.transaction')]" model="ir.model"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# 90 günden eski işlemleri arşivle
cutoff_date = datetime.datetime.now() - datetime.timedelta(days=90)
old_transactions = env['payment.transaction'].search([
    ('create_date', '<', cutoff_date),
    ('state', 'in', ['done', 'cancel', 'error']),
])

# İşlem tarihçesini arşivle
for tx in old_transactions:
    if tx.history_ids:
        # Tarihçeyi arşiv kaydına dönüştür
        pass
            ]]></field>
            <field name="interval_number">1</field>
            <field name="interval_type">weeks</field>
            <field name="numbercall">-1</field>
            <field name="doall" eval="False"/>
            <field name="active" eval="True"/>
        </record>

        <!-- Başarısız İşlemleri Temizle -->
        <record id="cron_cleanup_failed_transactions" model="ir.cron">
            <field name="name">POS: Başarısız İşlemleri Temizle</field>
            <field name="model_id" search="[('model', '=', 'payment.transaction')]" model="ir.model"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# 30 günden eski başarısız işlemleri temizle
cutoff_date = datetime.datetime.now() - datetime.timedelta(days=30)
failed_transactions = env['payment.transaction'].search([
    ('create_date', '<', cutoff_date),
    ('state', '=', 'error'),
    ('pos_order_id', '=', False),
])

# Başarısız işlemleri sil
failed_transactions.unlink()
            ]]></field>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field>
            <field name="doall" eval="False"/>
            <field name="active" eval="True"/>
        </record>
    </data>
</odoo>
